# PR-Service - –¢–µ—Å—Ç–æ–≤–æ–µ –∑–∞–¥–∞–Ω–∏–µ

## –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

`git clone https://github.com/oooooorg/PR-Service.git`   
`cd PR-Service`  
``docker-compose up``

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å—Ç–∞—Ä—Ç–∞, API –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ –ø–æ –∞–¥—Ä–µ—Å—É localhost:8080.  

## üõ†Ô∏è –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫

| –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è | –í–µ—Ä—Å–∏—è     | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ                    |
|------------|------------|-------------------------------|
| **Go** | 1.24.1     | –Ø–∑—ã–∫ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è         |
| **Echo** | v4         | HTTP Framework                |
| **PostgreSQL** | 15         | –†–µ–ª—è—Ü–∏–æ–Ω–Ω–∞—è –ë–î                |
| **slog** | built-in   | –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ |
| **Prometheus** | latest     | –ú–µ—Ç—Ä–∏–∫–∏                       |
| **Grafana** | Enterprise | –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è                  |
| **k6** | latest     | –ù–∞–≥—Ä—É–∑–æ—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ      |
| **golangci-lint** | latest     | –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑            |
| **Docker Compose** | v3.8       | –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–∞—Ü–∏—è               |

### –ü–æ—Ä—Ç—ã —Å–µ—Ä–≤–∏—Å–æ–≤

| –°–µ—Ä–≤–∏—Å | –ü–æ—Ä—Ç | URL                   |
|--------|------|-----------------------|
| API | 8080 | http://localhost:8080 |
| PostgreSQL | 5432 | http://localhost:5432 |
| Prometheus | 9090 | http://localhost:9090 |
| Grafana | 3000 | http://localhost:3000 |

#### –î–∞–Ω–Ω—ã–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

–ò–∑–Ω–∞—á–∞–ª—å–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ë–î –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞—é—Ç—Å—è –ø–æ –æ–ø–∏—Å–∞–Ω–Ω—ã–º –≤ `config.yml` –∏ `docker-compose.yml` —Ñ–∞–π–ª–∞—Ö. **–ü—Ä–∏ –∂–µ–ª–∞–Ω–∏–∏**, –∏—Ö –º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å. –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ `config.yml` (–¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞)
–û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ `docker-compose.yml` (–¥–ª—è Docker):

**config.yml**
```database:   
host: ""   
port: ""  
user: ""  
password: ""  
dbname: ""
```


**docker-compose.yml**
```
- DB_HOST=
- DB_PORT=
- DB_USER=
- DB_PASSWORD=
- DB_NAME=
- DB_SSLMODE=
```


## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è

### –≠–Ω–¥–ø–æ–∏–Ω—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏

–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ –ø–æ `localhost:8080/metrics` –∏ `localhost:3000` —á–µ—Ä–µ–∑ Grafana. Datasource —á–µ—Ä–µ–∑ Prometheus.
–í Grafana –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–µ—Ç—Å—è Dashboard, –æ—Ç–æ–±—Ä–∞–∂–∞—é—â–∏–π RPS, Latency, –ó–∞–ø—Ä–æ—Å—ã –ø–æ –µ–Ω–¥–ø–æ–∏–Ω—Ç–∞–º, –û—Ç–≤–µ—Ç—ã –ø–æ —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞–º, –ø—Ä–æ—Ü–µ–Ω—Ç –æ—à–∏–±–æ–∫ –∏ –¥—Ä.

### –ù–∞–≥—Ä—É–∑–æ—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –Ω–∞–≥—Ä—É–∑–æ—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ `k6`. –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤–∏–¥–Ω—ã –Ω–∞ —Ñ–∞–π–ª–µ `results-load-test.png`
–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: 7 –º–∏–Ω—É—Ç
**–≠—Ç–∞–ø—ã –Ω–∞–≥—Ä—É–∑–∫–∏:**
- 0-30s: —Ä–∞–∑–æ–≥—Ä–µ–≤ –¥–æ 10 VUs
- 30s-1m30s: —Ä–æ—Å—Ç –¥–æ 50 VUs
- 1m30s-3m30s: —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏—è –Ω–∞ 50 VUs
- 3m30s-4m30s: —Ä–æ—Å—Ç –¥–æ 100 VUs
- 4m30s-6m30s: –ø–∏–∫–æ–≤–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ 100 VUs
- 6m30s-7m: graceful shutdown

**–°—Ü–µ–Ω–∞—Ä–∏–π:**
1. –°–æ–∑–¥–∞–Ω–∏–µ PR —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ–º —Ä–µ–≤—å—é–µ—Ä–æ–≤
2. –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ PR –¥–ª—è —Ä–µ–≤—å—é (2 –∑–∞–ø—Ä–æ—Å–∞)
3. –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ 100 VUs

![–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞](esults-load-test.png)

–î–ª—è –∑–∞–ø—É—Å–∫–∞ 

``
docker-compose --profile load-test run --rm k6 run /scripts/create-pr-test.js
``

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ª–∏–Ω—Ç–µ—Ä–∞

–û–ø–∏—Å–∞–Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ª–∏–Ω—Ç–µ—Ä–∞ –≤ —Ñ–∞–π–ª–µ `.golangci.yml`

## –†–µ—à–µ–Ω–∏—è, –Ω–µ –æ–ø–∏—Å–∞–Ω–Ω—ã–µ –≤ —Ç–∑

- –ù–∞ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ, —Å –º–æ–µ–π —Ç–æ—á–∫–∏ –∑—Ä–µ–Ω–∏—è, –∏ –Ω–µ–æ–ø–∏—Å–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –≤ `openapi` —Å–∏—Ç—É–∞—Ü–∏–∏ –∏ –∑–∞–ø—Ä–æ—Å—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è 500 –∫–æ–¥–æ–º –æ—à–∏–±–∫–∏.  
- –õ–æ–≥–∏—Ä–æ–≤–Ω–∏–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ —á–µ—Ä–µ–∑ `slog`. 
- –í `/pullRequest/reassign` –æ–¥–Ω–æ –∏–∑ required –ø–æ–ª–µ–π –±—ã–ª–æ –ø–æ–º–µ–Ω—è–Ω–æ –Ω–∞ `old_user_id` –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –ø–æ —Å–ø–µ–∫–µ —Ñ–∞–π–ª—É.